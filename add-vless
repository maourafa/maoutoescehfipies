#!/bin/bash
clear
# Fungsi warna
red() { echo -e "\\033[32;1m${*}\\033[0m"; }
NC='\e[0m'
GREEN='\033[0;32m'
YELL='\033[1;33m'

# Konfigurasi Telegram
TIMES="10"
CHATID="5581268701"
KEY="8073851026:AAE9tlPoU-GP4urnVto5auLGS0rd3wi2JT0"
URL="https://api.telegram.org/bot$KEY/sendMessage"
domain=$(cat /etc/xray/domain)
PUB=$(cat /etc/slowdns/server.pub)
CITY=$(cat /etc/xray/city)
NS=$(cat /etc/xray/dns)
ipsaya=$(wget -qO- ipinfo.io/ip)
data_server=$(curl -v --insecure --silent https://google.com/ 2>&1 | grep Date | sed -e 's/< Date: //')
date_list=$(date +"%Y-%m-%d" -d "$data_server")

send_telegram_message() {
  local message="$TEXT"
  local encoded_message=$(echo "$message" | sed 's/&/&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')

  # Debug info
  echo -e "${YELL}Mengirim pesan ke Telegram...${NC}"
  echo -e "Chat ID: ${GREEN}$CHATID${NC}"

  # Kirim pesan
  curl_response=$(curl -s --max-time $TIMES -d "chat_id=$CHATID&disable_web_page_preview=1&text=$(echo "$encoded_message" | jq -s -R -r @uri)&parse_mode=HTML" "$URL" 2>&1)

  if [ $? -ne 0 ]; then
    echo -e "${RED}Gagal mengirim pesan ke Telegram. Error:${NC}"
    echo "$curl_response"
    return 1
  else
    echo -e "${GREEN}Pesan berhasil dikirim ke Telegram${NC}"
    return 0
  fi
}
# Header
echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e " \e[1;97;101m            ADD VLESS ACCOUNT           \e[0m"
echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"

# Input user
until [[ $user =~ ^[a-zA-Z0-9_]+$ && ${CLIENT_EXISTS} == '0' ]]; do
  read -rp "User: " -e user
  CLIENT_EXISTS=$(grep -w $user /etc/xray/config.json | wc -l)

  if [[ ${CLIENT_EXISTS} == '1' ]]; then
    clear
    echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e " \e[1;97;101m            ADD VLESS ACCOUNT           \e[0m"
    echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    echo -e "${RED}Username sudah digunakan. Silakan pilih nama lain.${NC}"
    echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
    read -n 1 -s -r -p "Press [ Enter ] to back menu vless"
    vless
  fi
done

# Generate UUID
uuid=$(cat /proc/sys/kernel/random/uuid)

# Input masa aktif dan quota
read -p "Expired (days): " masaaktif
read -p "Limit User (GB): " Quota
read -p "Limit IP: " ip
# Product selection
products=("SG-STANDAR" "SG-VIP" "SG-STB STANDAR" "SG-STB VIP")
echo "Pilih produk:"
for i in "${!products[@]}"; do
  echo "$((i+1)). ${products[$i]}"
done
read -p "Pilihan produk (1-${#products[@]}): " choice

if [[ $choice -ge 1 && $choice -le ${#products[@]} ]]; then
  produk=${products[$((choice-1))]}
  echo "Anda memilih: $produk"
else
  echo "Pilihan tidak valid!"
  exit 1
fi

# Price selection based on product
case $produk in
  "SG-STANDAR")
    harga=("3 Hari: Rp1.000" "7 Hari: Rp3.000" "15 Hari: Rp6.000" "30 Hari: Rp8.000")
    ;;
  "SG-VIP")
    harga=("3 Hari: Rp3.000" "7 Hari: Rp6.000" "15 Hari: Rp9.000" "30 Hari: Rp10.000")
    ;;
  "SG-STB STANDAR")
    harga=("30 Hari: Rp15.000" "60 Hari: Rp28.000")
    ;;
  "SG-STB VIP")
    harga=("30 Hari: Rp18.000" "60 Hari: Rp34.000")
    ;;
esac

echo "Pilih Harga:"
for i in "${!harga[@]}"; do
  echo "$((i+1)). ${harga[$i]}"
done
read -p "Pilihan harga (1-${#harga[@]}): " price_choice

if [[ $price_choice -ge 1 && $price_choice -le ${#harga[@]} ]]; then
  selected_price=${harga[$((price_choice-1))]}
  # Extract only the price part (RpX.XXX)
  price_only=$(echo "$selected_price" | grep -o 'Rp[0-9,.]*')
  echo "Anda memilih: $selected_price"
else
  echo "Pilihan tidak valid!"
  exit 1
fi

# Hitung tanggal
tgl=$(date -d "$masaaktif days" +"%d")
bln=$(date -d "$masaaktif days" +"%b")
thn=$(date -d "$masaaktif days" +"%Y")
expe="$tgl $bln, $thn"
tgl2=$(date +"%d")
bln2=$(date +"%b")
thn2=$(date +"%Y")
tnggl="$tgl2 $bln2, $thn2"
exp=$(date -d "$masaaktif days" +"%Y-%m-%d")

# Tambahkan user ke config.json
sed -i '/#vless$/a\#vl# '"$user $exp"'\
},{"id": "'""$uuid""'","email": "'""$user""'"' /etc/xray/config.json
sed -i '/#vlessgrpc$/a\#vl# '"$user $exp"'\
},{"id": "'""$uuid""'","email": "'""$user""'"' /etc/xray/config.json

vlesslink1="vless://${uuid}@${domain}:443?path=/vless&security=tls&encryption=none&host=${domain}&type=ws#${user}"
vlesslink2="vless://${uuid}@${domain}:80?path=/vless&encryption=none&host=${domain}&type=ws#${user}"
vlesslink3="vless://${uuid}@${domain}:443?mode=gun&security=tls&encryption=none&type=grpc&serviceName=vless-grpc&sni=${domain}#${user}"

# Buat file konfigurasi
cat >/var/www/html/database/vless-$user.txt <<-END
_________________________________________________________
*_DETAIL PEMBELIAN_*
_________________________________________________________
-» PRODUK : ${produk}
-» REGION : Singapore
-» REQ NAMA : ${user}
-» DEVICE : ${ip} IP
-» HARGA : ${selected_price}
-» AKTIF : ${masaaktif}
-» TGL EXP : ${exp}
_________________________________________________________
    SUCCES CREATE AKUN VLESS
_________________________________________________________
Remarks      : ${user}
Domain       : ${domain}
Location     : $CITY
User Quota   : ${Quota} GB
Port TLS     : 443
Port DNS     : 443, 53
Port NTLS    : 80, 8080, 2086
Port GRPC    : 443
Port XRAY    : 443,80
User ID      : ${uuid}
AlterId      : 0
Security     : auto
Network      : WS or gRPC
Path         : /vless - /multipath
_________________________________________________________
Link TLS     :
${vlesslink1}
_________________________________________________________
Link NTLS    :
${vlesslink2}
_________________________________________________________
Link GRPC    :
${vlesslink3}
_________________________________________________________
Format OpenClash : https://${domain}:81/vless-$user.txt
_________________________________________________________
Aktif Selama   : $masaaktif Hari
Dibuat Pada    : $tnggl
Berakhir Pada  : $exp
END
TEXT="
━━━━━━━━━━━━━━━━━━━━━━━━━━
*_DETAIL PEMBELIAN_*
━━━━━━━━━━━━━━━━━━━━━━━━━━
-» PRODUK : ${produk}
-» REGION : Singapore
-» REQ NAMA : ${user}
-» DEVICE : ${ip} IP
-» HARGA : ${selected_price}
-» AKTIF : ${masaaktif}
-» TGL EXP : ${exp}
━━━━━━━━━━━━━━━━━━━━━━━━━━
    SUCCES CREATE AKUN VLESS
━━━━━━━━━━━━━━━━━━━━━━━━━━
Remarks      : ${user}
Domain       : ${domain}
Location     : $CITY
User Quota   : ${Quota} GB
Port TLS     : 443
Port DNS     : 443, 53
Port NTLS    : 80, 8080, 2086
Port GRPC    : 443
Port XRAY    : 443,80
User ID      : ${uuid}
AlterId      : 0
Security     : auto
Network      : WS or gRPC
Path         : /vless - /multipath
━━━━━━━━━━━━━━━━━━━━━━━━━━
Link TLS     :
${vlesslink1}
━━━━━━━━━━━━━━━━━━━━━━━━━━━
Link NTLS    :
${vlesslink2}
━━━━━━━━━━━━━━━━━━━━━━━━━━━
Link GRPC    :
${vlesslink3}
━━━━━━━━━━━━━━━━━━━━━━━━━━━
Format OpenClash : https://${domain}:81/vless-$user.txt
━━━━━━━━━━━━━━━━━━━━━━━━━━━
Aktif Selama   : $masaaktif Hari
Dibuat Pada    : $tnggl
Berakhir Pada  : $exp
"
send_telegram_message

# Buat direktori jika belum ada
if [ ! -e /etc/vless ]; then
  mkdir -p /etc/vless
fi

# Handle quota
if [ -z ${Quota} ]; then
  Quota="0"
fi

c=$(echo "${Quota}" | sed 's/[^0-9]*//g')
d=$((${c} * 1024 * 1024 * 1024))

if [[ ${c} != "0" ]]; then
  echo "${d}" >/etc/vless/${user}
fi

# Update database
DATADB=$(cat /etc/vless/.vless.db | grep "^#vl#" | grep -w "${user}" | awk '{print $2}')
if [[ "${DATADB}" != '' ]]; then
  sed -i "/\b${user}\b/d" /etc/vless/.vless.db
fi
echo "#vl# ${user} ${exp} ${uuid} ${Quota}" >>/etc/vless/.vless.db
# Tampilkan hasil
sleep 3
clear
echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo -e "*_DETAIL PEMBELIAN_*"
echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo -e "-» PRODUK : ${produk}"
echo -e "-» REGION : Singapore"
echo -e "-» REQ NAMA : ${user}"
echo -e "-» DEVICE : ${ip} IP"
echo -e "-» HARGA : ${selected_price}"
echo -e "-» AKTIF : ${masaaktif}"
echo -e "-» TGL EXP : ${exp}"
echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo -e "    SUCCES CREATE AKUN VLESS"
echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e " \e[1;97;101m       SUCCES CREAT VLESS ACCOUNT       \e[0m"
echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e "Remarks     : ${user}"
echo -e "Domain      : ${domain}"
echo -e "Location    : $CITY"
echo -e "User Quota  : ${Quota} GB"
echo -e "Port TLS    : 443"
echo -e "Port DNS    : 443, 53"
echo -e "Port NTLS   : 80, 8080, 2086"
echo -e "Port GRPC   : 443"
echo -e "Port XRAY   : 443,80"
echo -e "User ID     : ${uuid}"
echo -e "AlterId     : 0"
echo -e "Security    : auto"
echo -e "Encryption  : none"
echo -e "Network     : WS/GRPC"
echo -e "Path        : /vless"
echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e "Link TLS    : ${vlesslink1}"
echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e "Link NTLS   : ${vlesslink2}"
echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e "Link GRPC   : ${vlesslink3}"
echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e "Format OpenClash : https://${domain}:81/vless-$user.txt"
echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e "Aktif Selama   : $masaaktif Hari"
echo -e "Dibuat Pada    : $tnggl"
echo -e "Berakhir Pada  : $expe"
echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
read -n 1 -s -r -p "Press [ Enter ] to back menu vless"
# Restart service
systemctl restart xray
systemctl restart nginx
service cron restart
vless